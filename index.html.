<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ArtMintX — Marketplace</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#070b14;--card:#0d1424;--muted:#a9b6c7;--accent:#06b6d4}
  *{font-family:Inter,system-ui,Arial}
  body{background:linear-gradient(180deg,#070b14,#0a0f20);color:#e6eef7}
  .navbar{background:rgba(255,255,255,.02)!important;border-bottom:1px solid rgba(255,255,255,.06)}
  .card-ghost{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:1rem}
  .muted{color:var(--muted)}
  .brand{font-weight:800;letter-spacing:.3px}
  .btn-primary{background:var(--accent);border:none}
  .art-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:1rem;overflow:hidden}
  .art-card img{width:100%;height:180px;object-fit:cover}
  .price-badge{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.06);padding:.2rem .5rem;border-radius:.6rem;font-size:.85rem}
  .form-control, .form-select{background:#0f182a;border:1px solid rgba(255,255,255,.08);color:#e8f2ff}
  .nav-pills .nav-link.active{background:var(--accent)}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand text-white brand" href="#">ArtMintX</a>
    <div class="ms-auto d-flex gap-2">
      <button id="btnDiscoverNav" class="btn btn-outline-light btn-sm">Discover</button>
      <button id="btnLogout" class="btn btn-outline-light btn-sm d-none">Logout</button>
    </div>
  </div>
</nav>

<div class="container py-4">

  <!-- Auth Card -->
  <div id="authCard" class="card-ghost p-4 mx-auto" style="max-width:950px;">
    <div class="row g-4">
      <div class="col-md-6">
        <h4 class="mb-3">Welcome to ArtMintX</h4>
        <p class="muted mb-4">Mint and showcase your digital art. Fund your wallet in BTC or SOL, set your price, and publish to the marketplace.</p>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="login-tab" data-bs-toggle="pill" data-bs-target="#login-pane" type="button" role="tab">Login</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="register-tab" data-bs-toggle="pill" data-bs-target="#register-pane" type="button" role="tab">Register</button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Login -->
          <div class="tab-pane fade show active" id="login-pane" role="tabpanel">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="loginEmail" type="email" class="form-control" placeholder="you@example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input id="loginPass" type="password" class="form-control" placeholder="••••••••">
            </div>
            <button id="btnLogin" class="btn btn-primary w-100">Login</button>
          </div>

          <!-- Register -->
          <div class="tab-pane fade" id="register-pane" role="tabpanel">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input id="regUsername" class="form-control" placeholder="artistname">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="regEmail" type="email" class="form-control" placeholder="you@example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input id="regPass" type="password" class="form-control" placeholder="Create a password">
            </div>
            <button id="btnRegister" class="btn btn-primary w-100">Create Account</button>
          </div>
        </div>
      </div>

      <div class="col-md-6 d-flex align-items-center">
        <div>
          <div class="p-3 rounded" style="background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.08)">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="muted">Live Conversion</div>
                <div class="mt-1">1 BTC ≈ <span id="rateBTC">…</span> USD</div>
                <div>1 SOL ≈ <span id="rateSOL">…</span> USD</div>
              </div>
              <div class="text-end">
                <div class="muted">Mint Fee</div>
                <div class="fs-5">$10 ≈ <span id="tenInBTC">…</span> BTC / <span id="tenInSOL">…</span> SOL</div>
              </div>
            </div>
          </div>
          <div class="muted small mt-2">Rates refresh automatically.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash" class="d-none">
    <div class="row g-3">
      <!-- Wallet -->
      <div class="col-lg-4">
        <div class="card-ghost p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Wallet</h5>
            <span class="price-badge">USD</span>
          </div>
          <div class="display-6">$<span id="balance">0.00</span></div>
          <div class="muted small">Funds can be added with BTC or SOL.</div>
          <button id="btnFund" class="btn btn-primary w-100 mt-3">Fund Wallet</button>
        </div>
      </div>

      <!-- Upload / Mint -->
      <div class="col-lg-4">
        <div class="card-ghost p-3 h-100">
          <h5 class="mb-2">Upload Artwork</h5>
          <div class="muted small mb-2">Mint fee is fixed at <strong>$10</strong>.</div>
          <div class="mb-2">
            <label class="form-label">Title</label>
            <input id="artTitle" class="form-control" placeholder="My Masterpiece">
          </div>
          <div class="mb-2">
            <label class="form-label">Image URL</label>
            <input id="artImg" class="form-control" placeholder="https://…/image.jpg">
          </div>
          <div class="mb-3">
            <label class="form-label">Your selling price (USD)</label>
            <input id="artPrice" type="number" min="1" class="form-control" placeholder="e.g. 120">
          </div>
          <button id="btnMint" class="btn btn-primary w-100">Mint & Submit</button>
          <div class="small muted mt-2">Upon submit, $10 is charged from your wallet and the artwork is reviewed.</div>
        </div>
      </div>

      <!-- Discover -->
      <div class="col-lg-4">
        <div class="card-ghost p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Discover</h5>
            <div class="input-group input-group-sm" style="max-width:220px">
              <input id="searchBox" class="form-control" placeholder="Search users/art">
              <button id="btnSearch" class="btn btn-outline-light">Go</button>
            </div>
          </div>
          <div class="muted small mt-2">Browse active artworks below.</div>
        </div>
      </div>
    </div>

    <!-- Gallery -->
    <div class="mt-3" id="galleryRow" class="row g-3"></div>
    <div class="row g-3 mt-1" id="gallery"></div>
  </div>
</div>

<!-- Fund Modal -->
<div class="modal fade" id="fundModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Fund Wallet</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Amount (USD)</label>
          <input id="fundUSD" type="number" min="5" class="form-control" placeholder="Enter amount e.g. 50">
        </div>
        <div class="mb-2">
          <label class="form-label">Choose Network</label>
          <select id="fundChain" class="form-select">
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="SOL">SOL (Solana)</option>
          </select>
        </div>
        <div class="p-2 rounded" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)">
          <div class="small muted">Send the equivalent crypto to the address below. Funds reflect after confirmation.</div>
          <div class="mt-2">
            <div>BTC Address:</div>
            <code id="btcAddr">bc1qq6tzrya3sn5m3nee6f6vzfa59wprvplkj45ulk</code>
          </div>
          <div class="mt-2">
            <div>SOL Address:</div>
            <code id="solAddr">G2GYyxj4bjzdrxX4BUrgFFiB63e9QvcqbzPMuruRdBu1</code>
          </div>
          <div class="mt-2 small">
            <span class="muted">You’ll send:</span>
            <span id="fundCalc">—</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnFundConfirm" class="btn btn-primary">I’ve Sent</button>
        <button class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1300">
  <div id="mainToast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Saved</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDX5l-iBZLWspb6bOlQSMvm7PnP2MYBs5o",
    authDomain: "artmintx.firebaseapp.com",
    projectId: "artmintx",
    storageBucket: "artmintx.firebasestorage.app",
    messagingSenderId: "209020671049",
    appId: "1:209020671049:web:df8f1f8b986a747ba1db98"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = id => document.getElementById(id);
  const toast = new bootstrap.Toast($('#mainToast'));
  function notify(msg){ $('toastBody').innerText = msg; toast.show(); }

  // Rates
  let usdPerBTC = null, usdPerSOL = null;
  async function refreshRates(){
    try{
      const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,solana&vs_currencies=usd",{cache:"no-store"});
      const j = await r.json();
      usdPerBTC = j.bitcoin.usd; usdPerSOL = j.solana.usd;
      $('rateBTC').innerText = usdPerBTC.toLocaleString();
      $('rateSOL').innerText = usdPerSOL.toLocaleString();
      $('tenInBTC').innerText = (10/usdPerBTC).toFixed(8);
      $('tenInSOL').innerText = (10/usdPerSOL).toFixed(6);
      updateFundCalc();
    }catch(e){ console.log('rate error', e); }
  }
  setInterval(refreshRates, 30000);
  refreshRates();

  // Auth
  $('btnRegister').onclick = async ()=>{
    const u = $('regUsername').value.trim();
    const e = $('regEmail').value.trim();
    const p = $('regPass').value;
    if(!u || !e || !p) return alert('Fill all fields');
    try{
      const cred = await createUserWithEmailAndPassword(auth, e, p);
      await setDoc(doc(db, 'users', cred.user.uid), {
        username: u, email: e, balanceUSD: 0, createdAt: serverTimestamp()
      });
      notify('Account created. Logged in.');
    }catch(err){ alert(err.message || err.code); }
  };

  $('btnLogin').onclick = async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    if(!e || !p) return alert('Enter email and password');
    try{
      await signInWithEmailAndPassword(auth, e, p);
    }catch(err){ alert(err.message || err.code); }
  };

  $('btnLogout').onclick = async ()=> { await signOut(auth); };

  let me = null; let meDocRef = null;
  onAuthStateChanged(auth, async user=>{
    if(user){
      me = user; meDocRef = doc(db,'users',user.uid);
      $('#authCard').classList.add('d-none');
      $('#dash').classList.remove('d-none');
      $('#btnLogout').classList.remove('d-none');
      // load wallets saved by admin if any
      const w = await getDoc(doc(db,'admin_wallets','main'));
      if(w.exists()){
        $('btcAddr').innerText = w.data().btc || $('btcAddr').innerText;
        $('solAddr').innerText = w.data().sol || $('solAddr').innerText;
      }
      // live balance
      onSnapshot(meDocRef, snap=>{
        const d = snap.data(); if(!d) return;
        $('balance').innerText = Number(d.balanceUSD||0).toFixed(2);
      });
      // load gallery
      initDiscover();
    }else{
      me = null; meDocRef = null;
      $('#authCard').classList.remove('d-none');
      $('#dash').classList.add('d-none');
      $('#btnLogout').classList.add('d-none');
    }
  });

  // Fund modal
  const fundModal = new bootstrap.Modal(document.getElementById('fundModal'));
  $('btnFund').onclick = ()=> fundModal.show();
  $('fundUSD').addEventListener('input', updateFundCalc);
  $('fundChain').addEventListener('change', updateFundCalc);

  function updateFundCalc(){
    const amt = Number($('fundUSD').value||0);
    if(!usdPerBTC || !usdPerSOL || !amt){ $('fundCalc').innerText = '—'; return; }
    const chain = $('fundChain').value;
    if(chain==='BTC'){
      $('fundCalc').innerText = `${(amt/usdPerBTC).toFixed(8)} BTC`;
    }else{
      $('fundCalc').innerText = `${(amt/usdPerSOL).toFixed(6)} SOL`;
    }
  }

  $('btnFundConfirm').onclick = async ()=>{
    if(!me) return;
    const amt = Number($('fundUSD').value||0);
    if(amt<=0) return alert('Enter USD amount');
    const chain = $('fundChain').value;
    const rate = chain==='BTC' ? usdPerBTC : usdPerSOL;
    const cryptoAmt = (amt/rate);
    // fetch username
    const meSnap = await getDoc(meDocRef);
    const uname = meSnap.exists()? (meSnap.data().username||me.email) : me.email;
    await addDoc(collection(db,'pending'),{
      userId: uname, type:'fund', amountUSD: amt,
      status:'waiting',
      chain, btcAmount: chain==='BTC'? cryptoAmt.toFixed(8):null,
      solAmount: chain==='SOL'? cryptoAmt.toFixed(6):null,
      createdAt: serverTimestamp()
    });
    fundModal.hide();
    notify('Submitted. Awaiting confirmation.');
  };

  // Upload / Mint flow
  $('btnMint').onclick = async ()=>{
    if(!me) return;
    const title = $('artTitle').value.trim();
    const img = $('artImg').value.trim();
    const price = Number($('artPrice').value||0);
    if(!title || !img || !price) return alert('Fill all fields');
    const meSnap = await getDoc(meDocRef);
    const data = meSnap.data() || {};
    const bal = Number(data.balanceUSD||0);
    if(bal < 10) return alert('Insufficient balance ($10 mint fee required). Please fund wallet.');
    // deduct $10
    await updateDoc(meDocRef, { balanceUSD: (bal - 10) });
    // create artwork (pending)
    const uname = data.username || me.email;
    await addDoc(collection(db,'artworks'),{
      title, imgUrl: img, priceUSD: price, owner: uname, status:'pending', createdAt: serverTimestamp()
    });
    // log pending mint for admin visibility
    await addDoc(collection(db,'pending'),{
      userId: uname, type:'mint', amountUSD: 10, status:'waiting', createdAt: serverTimestamp()
    });
    notify('Submitted for review.');
    // clear form
    $('artTitle').value=''; $('artImg').value=''; $('artPrice').value='';
  };

  // Discover grid
  const grid = document.getElementById('gallery');
  function renderArt(docList){
    grid.innerHTML='';
    docList.forEach(d=>{
      const a = d.data();
      if(a.status!=='active') return;
      const col = document.createElement('div');
      col.className='col-12 col-sm-6 col-md-4 col-lg-3';
      col.innerHTML = `
        <div class="art-card">
          <img src="${a.imgUrl}" alt="${a.title}">
          <div class="p-3">
            <div class="d-flex justify-content-between align-items-center">
              <strong>${a.title}</strong>
              <span class="price-badge">$${Number(a.priceUSD||0).toFixed(2)}</span>
            </div>
            <div class="muted small mt-1">by ${a.owner||'unknown'}</div>
          </div>
        </div>
      `;
      grid.appendChild(col);
    });
  }

  function initDiscover(){
    const artsQ = query(collection(db,'artworks'), orderBy('createdAt','desc'));
    onSnapshot(artsQ, snap=> renderArt(snap.docs));
  }

  // Simple search (filters current snapshot on text)
  $('btnSearch').onclick = ()=>{
    const q = ($('searchBox').value||'').toLowerCase().trim();
    if(!q){ initDiscover(); return;}
    // one-time fetch and filter
    getDocs(query(collection(db,'artworks'), orderBy('createdAt','desc'))).then(snap=>{
      const filtered = snap.docs.filter(d=>{
        const a = d.data();
        return (a.title||'').toLowerCase().includes(q) || (a.owner||'').toLowerCase().includes(q);
      });
      renderArt(filtered);
    });
  };

  // Top nav discover button
  $('btnDiscoverNav').onclick = ()=> document.getElementById('gallery').scrollIntoView({behavior:'smooth'});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
